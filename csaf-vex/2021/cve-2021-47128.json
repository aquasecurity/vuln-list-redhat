{
  "document": {
    "aggregate_severity": {
      "namespace": "https://access.redhat.com/security/updates/classification/",
      "text": "Low"
    },
    "category": "csaf_vex",
    "csaf_version": "2.0",
    "distribution": {
      "text": "Copyright Â© Red Hat, Inc. All rights reserved.",
      "tlp": {
        "label": "WHITE",
        "url": "https://www.first.org/tlp/"
      }
    },
    "lang": "en",
    "notes": [
      {
        "category": "legal_disclaimer",
        "text": "This content is licensed under the Creative Commons Attribution 4.0 International License (https://creativecommons.org/licenses/by/4.0/). If you distribute this content, or a modified version of it, you must provide attribution to Red Hat Inc. and provide a link to the original.",
        "title": "Terms of Use"
      }
    ],
    "publisher": {
      "category": "vendor",
      "contact_details": "https://access.redhat.com/security/team/contact/",
      "issuing_authority": "Red Hat Product Security is responsible for vulnerability handling across all Red Hat products and services.",
      "name": "Red Hat Product Security",
      "namespace": "https://www.redhat.com"
    },
    "references": [
      {
        "category": "self",
        "summary": "Canonical URL",
        "url": "https://security.access.redhat.com/data/csaf/v2/vex/2021/cve-2021-47128.json"
      }
    ],
    "title": "kernel: bpf, lockdown, audit: Fix buggy SELinux lockdown permission checks",
    "tracking": {
      "current_release_date": "2025-02-08T01:58:07+00:00",
      "generator": {
        "date": "2025-02-08T01:58:07+00:00",
        "engine": {
          "name": "Red Hat SDEngine",
          "version": "4.3.0"
        }
      },
      "id": "CVE-2021-47128",
      "initial_release_date": "2021-01-01T00:00:00+00:00",
      "revision_history": [
        {
          "date": "2021-01-01T00:00:00+00:00",
          "number": "1",
          "summary": "Initial version"
        },
        {
          "date": "2024-06-09T16:33:27+00:00",
          "number": "2",
          "summary": "Current version"
        },
        {
          "date": "2025-02-08T01:58:07+00:00",
          "number": "3",
          "summary": "Last generated version"
        }
      ],
      "status": "final",
      "version": "3"
    }
  },
  "product_tree": {
    "branches": [
      {
        "branches": [
          {
            "branches": [
              {
                "category": "product_name",
                "name": "Red Hat Enterprise Linux 6",
                "product": {
                  "name": "Red Hat Enterprise Linux 6",
                  "product_id": "red_hat_enterprise_linux_6",
                  "product_identification_helper": {
                    "cpe": "cpe:/o:redhat:enterprise_linux:6"
                  }
                }
              }
            ],
            "category": "product_family",
            "name": "Red Hat Enterprise Linux 6"
          },
          {
            "branches": [
              {
                "category": "product_name",
                "name": "Red Hat Enterprise Linux 7",
                "product": {
                  "name": "Red Hat Enterprise Linux 7",
                  "product_id": "red_hat_enterprise_linux_7",
                  "product_identification_helper": {
                    "cpe": "cpe:/o:redhat:enterprise_linux:7"
                  }
                }
              }
            ],
            "category": "product_family",
            "name": "Red Hat Enterprise Linux 7"
          },
          {
            "branches": [
              {
                "category": "product_name",
                "name": "Red Hat Enterprise Linux 8",
                "product": {
                  "name": "Red Hat Enterprise Linux 8",
                  "product_id": "red_hat_enterprise_linux_8",
                  "product_identification_helper": {
                    "cpe": "cpe:/o:redhat:enterprise_linux:8"
                  }
                }
              }
            ],
            "category": "product_family",
            "name": "Red Hat Enterprise Linux 8"
          },
          {
            "branches": [
              {
                "category": "product_name",
                "name": "Red Hat Enterprise Linux 9",
                "product": {
                  "name": "Red Hat Enterprise Linux 9",
                  "product_id": "red_hat_enterprise_linux_9",
                  "product_identification_helper": {
                    "cpe": "cpe:/o:redhat:enterprise_linux:9"
                  }
                }
              }
            ],
            "category": "product_family",
            "name": "Red Hat Enterprise Linux 9"
          },
          {
            "category": "product_version",
            "name": "kernel",
            "product": {
              "name": "kernel",
              "product_id": "kernel",
              "product_identification_helper": {
                "purl": "pkg:rpm/redhat/kernel?arch=src"
              }
            }
          },
          {
            "category": "product_version",
            "name": "kernel-rt",
            "product": {
              "name": "kernel-rt",
              "product_id": "kernel-rt",
              "product_identification_helper": {
                "purl": "pkg:rpm/redhat/kernel-rt?arch=src"
              }
            }
          }
        ],
        "category": "vendor",
        "name": "Red Hat"
      }
    ],
    "relationships": [
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel as a component of Red Hat Enterprise Linux 6",
          "product_id": "red_hat_enterprise_linux_6:kernel"
        },
        "product_reference": "kernel",
        "relates_to_product_reference": "red_hat_enterprise_linux_6"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel as a component of Red Hat Enterprise Linux 7",
          "product_id": "red_hat_enterprise_linux_7:kernel"
        },
        "product_reference": "kernel",
        "relates_to_product_reference": "red_hat_enterprise_linux_7"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel-rt as a component of Red Hat Enterprise Linux 7",
          "product_id": "red_hat_enterprise_linux_7:kernel-rt"
        },
        "product_reference": "kernel-rt",
        "relates_to_product_reference": "red_hat_enterprise_linux_7"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel as a component of Red Hat Enterprise Linux 8",
          "product_id": "red_hat_enterprise_linux_8:kernel"
        },
        "product_reference": "kernel",
        "relates_to_product_reference": "red_hat_enterprise_linux_8"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel-rt as a component of Red Hat Enterprise Linux 8",
          "product_id": "red_hat_enterprise_linux_8:kernel-rt"
        },
        "product_reference": "kernel-rt",
        "relates_to_product_reference": "red_hat_enterprise_linux_8"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel as a component of Red Hat Enterprise Linux 9",
          "product_id": "red_hat_enterprise_linux_9:kernel"
        },
        "product_reference": "kernel",
        "relates_to_product_reference": "red_hat_enterprise_linux_9"
      },
      {
        "category": "default_component_of",
        "full_product_name": {
          "name": "kernel-rt as a component of Red Hat Enterprise Linux 9",
          "product_id": "red_hat_enterprise_linux_9:kernel-rt"
        },
        "product_reference": "kernel-rt",
        "relates_to_product_reference": "red_hat_enterprise_linux_9"
      }
    ]
  },
  "vulnerabilities": [
    {
      "cve": "CVE-2021-47128",
      "cwe": {
        "id": "CWE-833",
        "name": "Deadlock"
      },
      "discovery_date": "2024-03-15T00:00:00+00:00",
      "flags": [
        {
          "label": "vulnerable_code_not_present",
          "product_ids": [
            "red_hat_enterprise_linux_6:kernel",
            "red_hat_enterprise_linux_7:kernel",
            "red_hat_enterprise_linux_7:kernel-rt",
            "red_hat_enterprise_linux_8:kernel",
            "red_hat_enterprise_linux_8:kernel-rt",
            "red_hat_enterprise_linux_9:kernel",
            "red_hat_enterprise_linux_9:kernel-rt"
          ]
        }
      ],
      "ids": [
        {
          "system_name": "Red Hat Bugzilla ID",
          "text": "2269831"
        }
      ],
      "notes": [
        {
          "category": "description",
          "text": "In the Linux kernel, the following vulnerability has been resolved:\n\nbpf, lockdown, audit: Fix buggy SELinux lockdown permission checks\n\nCommit 59438b46471a (\"security,lockdown,selinux: implement SELinux lockdown\")\nadded an implementation of the locked_down LSM hook to SELinux, with the aim\nto restrict which domains are allowed to perform operations that would breach\nlockdown. This is indirectly also getting audit subsystem involved to report\nevents. The latter is problematic, as reported by Ondrej and Serhei, since it\ncan bring down the whole system via audit:\n\n  1) The audit events that are triggered due to calls to security_locked_down()\n     can OOM kill a machine, see below details [0].\n\n  2) It also seems to be causing a deadlock via avc_has_perm()/slow_avc_audit()\n     when trying to wake up kauditd, for example, when using trace_sched_switch()\n     tracepoint, see details in [1]. Triggering this was not via some hypothetical\n     corner case, but with existing tools like runqlat \u0026 runqslower from bcc, for\n     example, which make use of this tracepoint. Rough call sequence goes like:\n\n     rq_lock(rq) -\u003e -------------------------+\n       trace_sched_switch() -\u003e               |\n         bpf_prog_xyz() -\u003e                   +-\u003e deadlock\n           selinux_lockdown() -\u003e             |\n             audit_log_end() -\u003e              |\n               wake_up_interruptible() -\u003e    |\n                 try_to_wake_up() -\u003e         |\n                   rq_lock(rq) --------------+\n\nWhat's worse is that the intention of 59438b46471a to further restrict lockdown\nsettings for specific applications in respect to the global lockdown policy is\ncompletely broken for BPF. The SELinux policy rule for the current lockdown check\nlooks something like this:\n\n  allow \u003cwho\u003e \u003cwho\u003e : lockdown { \u003creason\u003e };\n\nHowever, this doesn't match with the 'current' task where the security_locked_down()\nis executed, example: httpd does a syscall. There is a tracing program attached\nto the syscall which triggers a BPF program to run, which ends up doing a\nbpf_probe_read_kernel{,_str}() helper call. The selinux_lockdown() hook does\nthe permission check against 'current', that is, httpd in this example. httpd\nhas literally zero relation to this tracing program, and it would be nonsensical\nhaving to write an SELinux policy rule against httpd to let the tracing helper\npass. The policy in this case needs to be against the entity that is installing\nthe BPF program. For example, if bpftrace would generate a histogram of syscall\ncounts by user space application:\n\n  bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'\n\nbpftrace would then go and generate a BPF program from this internally. One way\nof doing it [for the sake of the example] could be to call bpf_get_current_task()\nhelper and then access current-\u003ecomm via one of bpf_probe_read_kernel{,_str}()\nhelpers. So the program itself has nothing to do with httpd or any other random\napp doing a syscall here. The BPF program _explicitly initiated_ the lockdown\ncheck. The allow/deny policy belongs in the context of bpftrace: meaning, you\nwant to grant bpftrace access to use these helpers, but other tracers on the\nsystem like my_random_tracer _not_.\n\nTherefore fix all three issues at the same time by taking a completely different\napproach for the security_locked_down() hook, that is, move the check into the\nprogram verification phase where we actually retrieve the BPF func proto. This\nalso reliably gets the task (current) that is trying to install the BPF tracing\nprogram, e.g. bpftrace/bcc/perf/systemtap/etc, and it also fixes the OOM since\nwe're moving this out of the BPF helper's fast-path which can be called several\nmillions of times per second.\n\nThe check is then also in line with other security_locked_down() hooks in the\nsystem where the enforcement is performed at open/load time, for example,\nopen_kcore() for /proc/kcore access or module_sig_check() for module signatures\njust to pick f\n---truncated---",
          "title": "Vulnerability description"
        },
        {
          "category": "summary",
          "text": "kernel: bpf, lockdown, audit: Fix buggy SELinux lockdown permission checks",
          "title": "Vulnerability summary"
        },
        {
          "category": "general",
          "text": "The CVSS score(s) listed for this vulnerability do not reflect the associated product's status, and are included for informational purposes to better understand the severity of this vulnerability.",
          "title": "CVSS score applicability"
        }
      ],
      "product_status": {
        "known_not_affected": [
          "red_hat_enterprise_linux_6:kernel",
          "red_hat_enterprise_linux_7:kernel",
          "red_hat_enterprise_linux_7:kernel-rt",
          "red_hat_enterprise_linux_8:kernel",
          "red_hat_enterprise_linux_8:kernel-rt",
          "red_hat_enterprise_linux_9:kernel",
          "red_hat_enterprise_linux_9:kernel-rt"
        ]
      },
      "references": [
        {
          "category": "self",
          "summary": "Canonical URL",
          "url": "https://access.redhat.com/security/cve/CVE-2021-47128"
        },
        {
          "category": "external",
          "summary": "RHBZ#2269831",
          "url": "https://bugzilla.redhat.com/show_bug.cgi?id=2269831"
        },
        {
          "category": "external",
          "summary": "https://www.cve.org/CVERecord?id=CVE-2021-47128",
          "url": "https://www.cve.org/CVERecord?id=CVE-2021-47128"
        },
        {
          "category": "external",
          "summary": "https://nvd.nist.gov/vuln/detail/CVE-2021-47128",
          "url": "https://nvd.nist.gov/vuln/detail/CVE-2021-47128"
        },
        {
          "category": "external",
          "summary": "https://lore.kernel.org/linux-cve-announce/2024031512-CVE-2021-47128-bef7@gregkh/T/#u",
          "url": "https://lore.kernel.org/linux-cve-announce/2024031512-CVE-2021-47128-bef7@gregkh/T/#u"
        }
      ],
      "release_date": "2024-03-15T00:00:00+00:00",
      "scores": [
        {
          "cvss_v3": {
            "version": "3.1",
            "vectorString": "CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:N/I:N/A:H",
            "attackVector": "LOCAL",
            "attackComplexity": "LOW",
            "privilegesRequired": "HIGH",
            "userInteraction": "NONE",
            "scope": "UNCHANGED",
            "confidentialityImpact": "NONE",
            "integrityImpact": "NONE",
            "availabilityImpact": "HIGH",
            "baseScore": 4.4,
            "baseSeverity": "MEDIUM"
          },
          "products": [
            "red_hat_enterprise_linux_6:kernel",
            "red_hat_enterprise_linux_7:kernel",
            "red_hat_enterprise_linux_7:kernel-rt",
            "red_hat_enterprise_linux_8:kernel",
            "red_hat_enterprise_linux_8:kernel-rt",
            "red_hat_enterprise_linux_9:kernel",
            "red_hat_enterprise_linux_9:kernel-rt"
          ]
        }
      ],
      "threats": [
        {
          "category": "impact",
          "details": "Low",
          "product_ids": [
            "red_hat_enterprise_linux_6:kernel",
            "red_hat_enterprise_linux_7:kernel",
            "red_hat_enterprise_linux_7:kernel-rt",
            "red_hat_enterprise_linux_8:kernel",
            "red_hat_enterprise_linux_8:kernel-rt",
            "red_hat_enterprise_linux_9:kernel",
            "red_hat_enterprise_linux_9:kernel-rt"
          ]
        }
      ],
      "title": "kernel: bpf, lockdown, audit: Fix buggy SELinux lockdown permission checks"
    }
  ]
}