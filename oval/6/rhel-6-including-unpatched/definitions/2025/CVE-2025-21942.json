{
  "Class": "vulnerability",
  "ID": "oval:com.redhat.cve:def:202521942",
  "Version": "636",
  "Metadata": {
    "Title": "kernel: btrfs: zoned: fix extent range end unlock in cow_file_range() (low)",
    "References": [
      {
        "Source": "CVE",
        "RefID": "CVE-2025-21942",
        "RefURL": "https://access.redhat.com/security/cve/CVE-2025-21942"
      }
    ],
    "Description": "DOCUMENTATION: The CVE program describes this issue as: In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: zoned: fix extent range end unlock in cow_file_range()\n\nRunning generic/751 on the for-next branch often results in a hang like\nbelow. They are both stack by locking an extent. This suggests someone\nforget to unlock an extent.\n\n  INFO: task kworker/u128:1:12 blocked for more than 323 seconds.\n        Not tainted 6.13.0-BTRFS-ZNS+ #503\n  \"echo 0 \u003e /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\n  task:kworker/u128:1  state:D stack:0     pid:12    tgid:12    ppid:2      flags:0x00004000\n  Workqueue: btrfs-fixup btrfs_work_helper [btrfs]\n  Call Trace:\n   \u003cTASK\u003e\n   __schedule+0x534/0xdd0\n   schedule+0x39/0x140\n   __lock_extent+0x31b/0x380 [btrfs]\n   ? __pfx_autoremove_wake_function+0x10/0x10\n   btrfs_writepage_fixup_worker+0xf1/0x3a0 [btrfs]\n   btrfs_work_helper+0xff/0x480 [btrfs]\n   ? lock_release+0x178/0x2c0\n   process_one_work+0x1ee/0x570\n   ? srso_return_thunk+0x5/0x5f\n   worker_thread+0x1d1/0x3b0\n   ? __pfx_worker_thread+0x10/0x10\n   kthread+0x10b/0x230\n   ? __pfx_kthread+0x10/0x10\n   ret_from_fork+0x30/0x50\n   ? __pfx_kthread+0x10/0x10\n   ret_from_fork_asm+0x1a/0x30\n   \u003c/TASK\u003e\n  INFO: task kworker/u134:0:184 blocked for more than 323 seconds.\n        Not tainted 6.13.0-BTRFS-ZNS+ #503\n  \"echo 0 \u003e /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\n  task:kworker/u134:0  state:D stack:0     pid:184   tgid:184   ppid:2      flags:0x00004000\n  Workqueue: writeback wb_workfn (flush-btrfs-4)\n  Call Trace:\n   \u003cTASK\u003e\n   __schedule+0x534/0xdd0\n   schedule+0x39/0x140\n   __lock_extent+0x31b/0x380 [btrfs]\n   ? __pfx_autoremove_wake_function+0x10/0x10\n   find_lock_delalloc_range+0xdb/0x260 [btrfs]\n   writepage_delalloc+0x12f/0x500 [btrfs]\n   ? srso_return_thunk+0x5/0x5f\n   extent_write_cache_pages+0x232/0x840 [btrfs]\n   btrfs_writepages+0x72/0x130 [btrfs]\n   do_writepages+0xe7/0x260\n   ? srso_return_thunk+0x5/0x5f\n   ? lock_acquire+0xd2/0x300\n   ? srso_return_thunk+0x5/0x5f\n   ? find_held_lock+0x2b/0x80\n   ? wbc_attach_and_unlock_inode.part.0+0x102/0x250\n   ? wbc_attach_and_unlock_inode.part.0+0x102/0x250\n   __writeback_single_inode+0x5c/0x4b0\n   writeback_sb_inodes+0x22d/0x550\n   __writeback_inodes_wb+0x4c/0xe0\n   wb_writeback+0x2f6/0x3f0\n   wb_workfn+0x32a/0x510\n   process_one_work+0x1ee/0x570\n   ? srso_return_thunk+0x5/0x5f\n   worker_thread+0x1d1/0x3b0\n   ? __pfx_worker_thread+0x10/0x10\n   kthread+0x10b/0x230\n   ? __pfx_kthread+0x10/0x10\n   ret_from_fork+0x30/0x50\n   ? __pfx_kthread+0x10/0x10\n   ret_from_fork_asm+0x1a/0x30\n   \u003c/TASK\u003e\n\nThis happens because we have another success path for the zoned mode. When\nthere is no active zone available, btrfs_reserve_extent() returns\n-EAGAIN. In this case, we have two reactions.\n\n(1) If the given range is never allocated, we can only wait for someone\n    to finish a zone, so wait on BTRFS_FS_NEED_ZONE_FINISH bit and retry\n    afterward.\n\n(2) Or, if some allocations are already done, we must bail out and let\n    the caller to send IOs for the allocation. This is because these IOs\n    may be necessary to finish a zone.\n\nThe commit 06f364284794 (\"btrfs: do proper folio cleanup when\ncow_file_range() failed\") moved the unlock code from the inside of the\nloop to the outside. So, previously, the allocated extents are unlocked\njust after the allocation and so before returning from the function.\nHowever, they are no longer unlocked on the case (2) above. That caused\nthe hang issue.\n\nFix the issue by modifying the 'end' to the end of the allocated\nrange. Then, we can exit the loop and the same unlock code can properly\nhandle the case.",
    "Advisory": {
      "From": "secalert@redhat.com",
      "Severity": "Low",
      "Issued": {},
      "Updated": {
        "Date": "2025-04-18"
      },
      "Cves": [
        {
          "CveID": "CVE-2025-21942",
          "Cvss3": "5.5/CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
          "Impact": "low",
          "Href": "https://access.redhat.com/security/cve/CVE-2025-21942",
          "Public": "20250401"
        }
      ],
      "AffectedCpeList": [
        "cpe:/a:redhat:rhel_extras:6",
        "cpe:/a:redhat:rhel_extras_hpn:6",
        "cpe:/a:redhat:rhel_extras_oracle_java:6",
        "cpe:/a:redhat:rhel_extras_sap:6",
        "cpe:/a:redhat:rhel_extras_sap_hana:6",
        "cpe:/o:redhat:enterprise_linux:6",
        "cpe:/o:redhat:enterprise_linux:6::client",
        "cpe:/o:redhat:enterprise_linux:6::computenode",
        "cpe:/o:redhat:enterprise_linux:6::server",
        "cpe:/o:redhat:enterprise_linux:6::workstation"
      ],
      "Affected": {
        "Resolution": {
          "State": "Out of support scope"
        }
      }
    }
  },
  "Criteria": {
    "Operator": "OR",
    "Criterions": [
      {
        "Comment": "Red Hat Enterprise Linux must be installed",
        "TestRef": "oval:com.redhat.cve:tst:20022439070"
      }
    ],
    "Criterias": [
      {
        "Operator": "AND",
        "Criterions": [
          {
            "Comment": "Red Hat Enterprise Linux 6 is installed",
            "TestRef": "oval:com.redhat.cve:tst:20022439069"
          }
        ],
        "Criterias": [
          {
            "Operator": "OR",
            "Criterias": [
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764019"
                  },
                  {
                    "Comment": "kernel-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764020"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764009"
                  },
                  {
                    "Comment": "kernel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-abi-whitelists is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764005"
                  },
                  {
                    "Comment": "kernel-abi-whitelists is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764006"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-firmware is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764015"
                  },
                  {
                    "Comment": "kernel-firmware is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764011"
                  },
                  {
                    "Comment": "kernel-kdump is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764012"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-bootwrapper is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764021"
                  },
                  {
                    "Comment": "kernel-bootwrapper is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "python-perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764017"
                  },
                  {
                    "Comment": "python-perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764001"
                  },
                  {
                    "Comment": "kernel-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764002"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764023"
                  },
                  {
                    "Comment": "kernel-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764024"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764025"
                  },
                  {
                    "Comment": "perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764026"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764007"
                  },
                  {
                    "Comment": "kernel-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764008"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764003"
                  },
                  {
                    "Comment": "kernel-kdump-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764004"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-headers is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20072764013"
                  },
                  {
                    "Comment": "kernel-headers is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20072764014"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}