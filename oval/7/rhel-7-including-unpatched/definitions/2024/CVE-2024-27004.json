{
  "Class": "vulnerability",
  "ID": "oval:com.redhat.cve:def:202427004",
  "Version": "636",
  "Metadata": {
    "Title": "kernel: clk: Get runtime PM before walking tree during disable_unused (low)",
    "References": [
      {
        "Source": "CVE",
        "RefID": "CVE-2024-27004",
        "RefURL": "https://access.redhat.com/security/cve/CVE-2024-27004"
      }
    ],
    "Description": "DOCUMENTATION: The MITRE CVE dictionary describes this issue as: In the Linux kernel, the following vulnerability has been resolved:\n\nclk: Get runtime PM before walking tree during disable_unused\n\nDoug reported [1] the following hung task:\n\n INFO: task swapper/0:1 blocked for more than 122 seconds.\n       Not tainted 5.15.149-21875-gf795ebc40eb8 #1\n \"echo 0 \u003e /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\n task:swapper/0       state:D stack:    0 pid:    1 ppid:     0 flags:0x00000008\n Call trace:\n  __switch_to+0xf4/0x1f4\n  __schedule+0x418/0xb80\n  schedule+0x5c/0x10c\n  rpm_resume+0xe0/0x52c\n  rpm_resume+0x178/0x52c\n  __pm_runtime_resume+0x58/0x98\n  clk_pm_runtime_get+0x30/0xb0\n  clk_disable_unused_subtree+0x58/0x208\n  clk_disable_unused_subtree+0x38/0x208\n  clk_disable_unused_subtree+0x38/0x208\n  clk_disable_unused_subtree+0x38/0x208\n  clk_disable_unused_subtree+0x38/0x208\n  clk_disable_unused+0x4c/0xe4\n  do_one_initcall+0xcc/0x2d8\n  do_initcall_level+0xa4/0x148\n  do_initcalls+0x5c/0x9c\n  do_basic_setup+0x24/0x30\n  kernel_init_freeable+0xec/0x164\n  kernel_init+0x28/0x120\n  ret_from_fork+0x10/0x20\n INFO: task kworker/u16:0:9 blocked for more than 122 seconds.\n       Not tainted 5.15.149-21875-gf795ebc40eb8 #1\n \"echo 0 \u003e /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\n task:kworker/u16:0   state:D stack:    0 pid:    9 ppid:     2 flags:0x00000008\n Workqueue: events_unbound deferred_probe_work_func\n Call trace:\n  __switch_to+0xf4/0x1f4\n  __schedule+0x418/0xb80\n  schedule+0x5c/0x10c\n  schedule_preempt_disabled+0x2c/0x48\n  __mutex_lock+0x238/0x488\n  __mutex_lock_slowpath+0x1c/0x28\n  mutex_lock+0x50/0x74\n  clk_prepare_lock+0x7c/0x9c\n  clk_core_prepare_lock+0x20/0x44\n  clk_prepare+0x24/0x30\n  clk_bulk_prepare+0x40/0xb0\n  mdss_runtime_resume+0x54/0x1c8\n  pm_generic_runtime_resume+0x30/0x44\n  __genpd_runtime_resume+0x68/0x7c\n  genpd_runtime_resume+0x108/0x1f4\n  __rpm_callback+0x84/0x144\n  rpm_callback+0x30/0x88\n  rpm_resume+0x1f4/0x52c\n  rpm_resume+0x178/0x52c\n  __pm_runtime_resume+0x58/0x98\n  __device_attach+0xe0/0x170\n  device_initial_probe+0x1c/0x28\n  bus_probe_device+0x3c/0x9c\n  device_add+0x644/0x814\n  mipi_dsi_device_register_full+0xe4/0x170\n  devm_mipi_dsi_device_register_full+0x28/0x70\n  ti_sn_bridge_probe+0x1dc/0x2c0\n  auxiliary_bus_probe+0x4c/0x94\n  really_probe+0xcc/0x2c8\n  __driver_probe_device+0xa8/0x130\n  driver_probe_device+0x48/0x110\n  __device_attach_driver+0xa4/0xcc\n  bus_for_each_drv+0x8c/0xd8\n  __device_attach+0xf8/0x170\n  device_initial_probe+0x1c/0x28\n  bus_probe_device+0x3c/0x9c\n  deferred_probe_work_func+0x9c/0xd8\n  process_one_work+0x148/0x518\n  worker_thread+0x138/0x350\n  kthread+0x138/0x1e0\n  ret_from_fork+0x10/0x20\n\nThe first thread is walking the clk tree and calling\nclk_pm_runtime_get() to power on devices required to read the clk\nhardware via struct clk_ops::is_enabled(). This thread holds the clk\nprepare_lock, and is trying to runtime PM resume a device, when it finds\nthat the device is in the process of resuming so the thread schedule()s\naway waiting for the device to finish resuming before continuing. The\nsecond thread is runtime PM resuming the same device, but the runtime\nresume callback is calling clk_prepare(), trying to grab the\nprepare_lock waiting on the first thread.\n\nThis is a classic ABBA deadlock. To properly fix the deadlock, we must\nnever runtime PM resume or suspend a device with the clk prepare_lock\nheld. Actually doing that is near impossible today because the global\nprepare_lock would have to be dropped in the middle of the tree, the\ndevice runtime PM resumed/suspended, and then the prepare_lock grabbed\nagain to ensure consistency of the clk tree topology. If anything\nchanges with the clk tree in the meantime, we've lost and will need to\nstart the operation all over again.\n\nLuckily, most of the time we're simply incrementing or decrementing the\nruntime PM count on an active device, so we don't have the chance to\nschedule away with the prepare_lock held. Let's fix this immediate\nproblem that can be\n---truncated---",
    "Advisory": {
      "From": "secalert@redhat.com",
      "Severity": "Low",
      "Issued": {},
      "Updated": {
        "Date": "2024-07-05"
      },
      "Cves": [
        {
          "CveID": "CVE-2024-27004",
          "Cvss3": "5.5/CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
          "Impact": "low",
          "Href": "https://access.redhat.com/security/cve/CVE-2024-27004",
          "Public": "20240501"
        }
      ],
      "AffectedCpeList": [
        "cpe:/a:redhat:rhel_extras:7",
        "cpe:/a:redhat:rhel_extras_oracle_java:7",
        "cpe:/a:redhat:rhel_extras_rt:7",
        "cpe:/a:redhat:rhel_extras_sap:7",
        "cpe:/a:redhat:rhel_extras_sap_hana:7",
        "cpe:/o:redhat:enterprise_linux:7",
        "cpe:/o:redhat:enterprise_linux:7::client",
        "cpe:/o:redhat:enterprise_linux:7::computenode",
        "cpe:/o:redhat:enterprise_linux:7::server",
        "cpe:/o:redhat:enterprise_linux:7::workstation"
      ],
      "Affected": {
        "Resolution": {
          "State": "Out of support scope"
        }
      }
    }
  },
  "Criteria": {
    "Operator": "OR",
    "Criterions": [
      {
        "Comment": "Red Hat Enterprise Linux must be installed",
        "TestRef": "oval:com.redhat.cve:tst:20042779006"
      }
    ],
    "Criterias": [
      {
        "Operator": "AND",
        "Criterions": [
          {
            "Comment": "Red Hat Enterprise Linux 7 is installed",
            "TestRef": "oval:com.redhat.cve:tst:20042779005"
          }
        ],
        "Criterias": [
          {
            "Operator": "OR",
            "Criterias": [
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542029"
                  },
                  {
                    "Comment": "perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542030"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542015"
                  },
                  {
                    "Comment": "kernel-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446051"
                  },
                  {
                    "Comment": "kernel-rt-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446052"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542011"
                  },
                  {
                    "Comment": "kernel-kdump is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542012"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-abi-whitelists is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542009"
                  },
                  {
                    "Comment": "kernel-abi-whitelists is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542005"
                  },
                  {
                    "Comment": "kernel-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542006"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542031"
                  },
                  {
                    "Comment": "kernel-kdump-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542032"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542019"
                  },
                  {
                    "Comment": "kernel-tools is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542020"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446017"
                  },
                  {
                    "Comment": "kernel-rt-trace-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "python-perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542013"
                  },
                  {
                    "Comment": "python-perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542014"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446015"
                  },
                  {
                    "Comment": "kernel-rt-trace is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542023"
                  },
                  {
                    "Comment": "kernel-tools-libs is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542024"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542007"
                  },
                  {
                    "Comment": "kernel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542008"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446019"
                  },
                  {
                    "Comment": "kernel-rt-debug-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446020"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542025"
                  },
                  {
                    "Comment": "kernel-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542026"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446027"
                  },
                  {
                    "Comment": "kernel-rt-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-headers is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542001"
                  },
                  {
                    "Comment": "kernel-headers is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542002"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542021"
                  },
                  {
                    "Comment": "kernel-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446005"
                  },
                  {
                    "Comment": "kernel-rt-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446006"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "bpftool is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542003"
                  },
                  {
                    "Comment": "bpftool is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542004"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446009"
                  },
                  {
                    "Comment": "kernel-rt-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-bootwrapper is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542027"
                  },
                  {
                    "Comment": "kernel-bootwrapper is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446049"
                  },
                  {
                    "Comment": "kernel-rt-trace-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446050"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542017"
                  },
                  {
                    "Comment": "kernel-tools-libs-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446045"
                  },
                  {
                    "Comment": "kernel-rt-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446046"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446007"
                  },
                  {
                    "Comment": "kernel-rt is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446008"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}